name: Build and Deploy

on:
  push:
    branches:
      - main

env:
  DEPLOYMENT_NAME: fe-app
  OAUTH_DOCKER: AQAAAAAM5fwgAATuwc-Y_W32pU11sWdj3ACgcVM
  CLUSTER_URL: https://51.250.11.247
  SA_TOKEN: eyJhbGciOiJSUzI1NiIsImtpZCI6ImNiLUNxbTZUU201a0dyUVBBbmZJWmw5OWlTREJlTjFoX0NLbE5yeGFFUUEifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlLXN5c3RlbSIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXF4eHF2Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiIwYmY5Y2M5Ny1jZjdjLTRjNTQtOWQ1ZS04YzMxNmM4MmFlMjciLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZS1zeXN0ZW06YWRtaW4tdXNlciJ9.BFKetBj-4pDXP87psdSiQplSCx0z9Ff5cU0NNd4htrY-5gjd0pr5lGhqkpCqmQ0Kr6MFhNyLDRwz69wVKjaM05CQ3qc_kKH-Jh1aGS34-IeyPGSfHPR3DZfrRV_inNS2DthhXdd1NT5MKtz0ewUH49jRs794GmzlMASaw-suYbXiqpGs34jOtW13AtojTdPtv3HL-12n-ewv7r5wjAQKqbAA8oxy3gu_eNYopkgnuvmmhDASJIlJF4FWH1vVQeNJms6U0J9446BQb_ubKvrSBYkyhSuPWLt5EyHVmwR2AznIUkiACQ7wb8zvTjXLuLasA1r_9sR-MmgdpJezr71BFw
  REGISTRY_ID: crpf0ksoueue60lg97jm

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Docker login
        run: |-
          docker login -u oauth -p $OAUTH_DOCKER cr.yandex

      - name: Build docker image
        run: |-
          docker build -t cr.yandex/$REGISTRY_ID/fe/fe:latest -f dockerfile ./fe

      - name: Push docker image
        run: |-
          docker push cr.yandex/$REGISTRY_ID/fe/fe:latest

      - name: Deploy to kubernetes
        run: |-
          kubectl config set-cluster cluster --server=$CLUSTER_URL --kubeconfig=test.kubeconfig --insecure-skip-tls-verify=true
          kubectl config set-credentials admin-user --token=$SA_TOKEN --kubeconfig=test.kubeconfig
          kubectl config set-context default --cluster=cluster --user=admin-user --kubeconfig=test.kubeconfig
          kubectl config use-context default --kubeconfig=test.kubeconfig
          kubectl -n default rollout restart deployment ${DEPLOYMENT_NAME} --kubeconfig=test.kubeconfig